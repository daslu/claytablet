<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Clojure IDE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
    #file-browser { width: 25%; border-right: 1px solid #ccc; padding: 10px; overflow-y: auto; }
    #editor { width: 75%; padding: 10px; display: flex; flex-direction: column; }
    #editor-area { flex: 1; height: 70vh; }
    #output { height: 30vh; border-top: 1px solid #ccc; padding: 10px; overflow-y: auto; background-color: #f9f9f9; }
    .file { cursor: pointer; padding: 5px; }
    .file:hover { background-color: #e0e0e0; }
    #instructions { padding: 10px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; }
    .file-path { font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <div id="file-browser">
    <h3>Files</h3>
    <div id="files"></div>
    <button id="save-btn">Save</button>
  </div>
  <div id="editor">
    <div id="instructions">
      <h3>Instructions</h3>
      <ul>
        <li>Select a file from the <strong>Files</strong> pane to load it into the editor.</li>
        <li>Edit the Clojure code in the <strong>Editor</strong> pane.</li>
        <li>Click the <strong>Save</strong> button to save your changes.</li>
        <li>Press <strong>Ctrl+Enter</strong> to evaluate the code and see the output in the <strong>Output</strong> pane.</li>
      </ul>
    </div>
    <h3>Editor</h3>
    <div id="editor-area"></div>
    <h3>Output</h3>
    <div id="output"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clojure/clojure.min.js"></script>
  <script>
    let currentFilePath = null;
    const editor = CodeMirror(document.getElementById('editor-area'), {
      mode: 'clojure',
      lineNumbers: true,
      value: '// Select a file to start editing'
    });

    function fetchFiles() {
      fetch('/api/files')
        .then(response => response.json())
        .then(data => {
          const filesDiv = document.getElementById('files');
          filesDiv.innerHTML = '';
          data.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file';
            
            const fileName = document.createElement('div');
            fileName.textContent = file.name;

            const filePath = document.createElement('div');
            filePath.className = 'file-path';
            filePath.textContent = file.path;

            fileDiv.appendChild(fileName);
            fileDiv.appendChild(filePath);
            fileDiv.onclick = () => loadFile(file.path);
            filesDiv.appendChild(fileDiv);
          });
        });
    }

    function loadFile(path) {
      fetch(`/api/files/${path}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('File not found');
          }
          return response.json();
        })
        .then(data => {
          currentFilePath = data.path;
          editor.setValue(data.content);
        })
        .catch(error => {
          alert(error.message);
        });
    }

    document.getElementById('save-btn').onclick = () => {
      if (!currentFilePath) {
        alert('No file selected.');
        return;
      }
      const content = editor.getValue();
      fetch(`/api/files/${currentFilePath}`, {
        method: 'POST',
        body: content
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('File saved successfully.');
        } else {
          alert('Failed to save file.');
        }
      })
      .catch(() => {
        alert('Error saving file.');
      });
    };

    // Example: Evaluate code on Ctrl+Enter
    editor.setOption('extraKeys', {
      'Ctrl-Enter': () => {
        const code = editor.getValue();
        fetch('/api/eval', {
          method: 'POST',
          body: code
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById('output').textContent = data.result;
        })
        .catch(() => {
          document.getElementById('output').textContent = 'Error evaluating code.';
        });
      }
    });

    // Initial fetch of files
    fetchFiles();
  </script>
</body>
</html>
